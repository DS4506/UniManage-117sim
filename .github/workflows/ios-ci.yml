name: iOS CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: List schemes (debug help)
        run: xcodebuild -list -project UniManage.xcodeproj

      - name: Pick, boot, and test on an available iOS Simulator
        shell: bash
        run: |
          set -euo pipefail

          echo "== Available simulators (installed on this runner) =="
          xcrun simctl list devices available || true

          # Pick the first AVAILABLE iOS Simulator device (prefer iPhone if possible)
          UDID="$(
            xcrun simctl list devices available |
              awk -F '[()]' '
                /iOS/ && /iPhone/ && /Booted|Shutdown/ { print $2; exit }
              '
          )"

          if [[ -z "${UDID}" ]]; then
            UDID="$(
              xcrun simctl list devices available |
                awk -F '[()]' '
                  /iOS/ && /Booted|Shutdown/ { print $2; exit }
                '
            )"
          fi

          if [[ -z "${UDID}" ]]; then
            echo "ERROR: No available iOS Simulator devices found on this runner."
            exit 1
          fi

          echo "Chosen simulator UDID: ${UDID}"

          echo "== Boot simulator =="
          xcrun simctl boot "${UDID}" || true
          xcrun simctl bootstatus "${UDID}" -b

          echo "== Run tests =="
          xcodebuild \
            -project UniManage.xcodeproj \
            -scheme UniManage \
            -sdk iphonesimulator \
            -destination "id=${UDID}" \
            -derivedDataPath DerivedData \
            clean test
