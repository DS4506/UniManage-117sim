name: iOS CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Show Xcode version
        run: |
          xcodebuild -version
          swift --version

      - name: List Xcode schemes (debugging help)
        run: |
          xcodebuild -list -project UniManage.xcodeproj

      - name: Pick latest available iOS runtime + create simulator (UDID)
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Available runtimes ==="
          xcrun simctl list runtimes

          RUNTIME_ID=$(
            xcrun simctl list runtimes |
            grep -E "iOS .*com\.apple\.CoreSimulator\.SimRuntime\.iOS-" |
            grep -v unavailable |
            tail -n 1 |
            sed -E 's/.*\((com\.apple\.CoreSimulator\.SimRuntime\.iOS-[^)]*)\).*/\1/'
          )

          if [[ -z "${RUNTIME_ID}" ]]; then
            echo "ERROR: No available iOS simulator runtime found on this runner."
            exit 1
          fi

          echo "Using runtime: ${RUNTIME_ID}"

          echo "=== Available device types ==="
          xcrun simctl list devicetypes

          DEVICE_TYPE_ID=$(
            xcrun simctl list devicetypes |
            grep -E "iPhone" |
            head -n 1 |
            sed -E 's/.*\((com\.apple\.CoreSimulator\.SimDeviceType\.[^)]*)\).*/\1/'
          )

          if [[ -z "${DEVICE_TYPE_ID}" ]]; then
            echo "ERROR: No iPhone simulator device type found."
            exit 1
          fi

          echo "Using device type: ${DEVICE_TYPE_ID}"

          UDID=$(xcrun simctl create "CI-iPhone" "${DEVICE_TYPE_ID}" "${RUNTIME_ID}")
          echo "Created simulator UDID: ${UDID}"

          echo "UDID=${UDID}" >> $GITHUB_ENV

      - name: Boot simulator
        shell: bash
        run: |
          set -euo pipefail
          xcrun simctl boot "${UDID}" || true
          xcrun simctl bootstatus "${UDID}" -b
          xcrun simctl list devices | head -n 60

      - name: Build and run UNIT tests (stable for CI)
        shell: bash
        run: |
          set -euo pipefail

          xcodebuild \
            -project UniManage.xcodeproj \
            -scheme UniManage \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,id=${UDID}" \
            -skip-testing:UniManageUITests \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            clean test

      - name: Upload test results (xcresult)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestResults-xcresult
          path: TestResults.xcresult

